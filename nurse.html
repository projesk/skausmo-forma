<!doctype html>
<html lang="lt">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Postas 1</title>

<style>
body{font-family:Arial;margin:0;background:#f5f6f8}
header{background:#fff;padding:12px 16px;border-bottom:1px solid #ddd;font-weight:bold}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:12px;
  padding:12px;
}

.ward{
  background:#fff;
  border:1px solid #ddd;
  border-radius:14px;
  padding:10px;
}

.bed{
  padding:6px 0;
  border-top:1px dashed #eee;
  font-size:14px;
}

.history{
  font-size:12px;
  color:#444;
  margin-top:3px;
  line-height:1.4;
}

button{
  border:0;
  border-radius:8px;
  padding:3px 7px;
  font-size:11px;
  cursor:pointer;
  margin-top:4px;
}

.clear{background:#b00020;color:#fff}
.done{background:#663399;color:#fff}
</style>
</head>

<body>

<header>
  Postas 1 – visos palatos
  <span id="time" style="font-size:12px;color:#666;margin-left:10px"></span>
</header>

<div class="grid" id="grid"></div>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbw4cdh6miY0FPdhHUaR8CxaRNarh01J1rY_QhCN7A5TTvyDgcDED57jZOBGk0g-m05b_A/exec";

/* ===== API ===== */
async function api(params){
  const url = SCRIPT_URL + "?" + new URLSearchParams(params);
  const res = await fetch(url);
  return await res.json();
}

/* ===== Grupavimas pagal palatas ===== */
function groupByWard(beds){
  const map={};
  for(const b of beds){
    const ward=b.bed.split("-")[0];
    if(!map[ward]) map[ward]=[];
    map[ward].push(b);
  }
  return map;
}

/* ===== HTML ===== */

function wardHTML(ward,beds){
  return `
  <div class="ward">
    <b>Palata ${ward}</b>
    ${beds.map(bedHTML).join("")}
  </div>`;
}

function bedHTML(b){
  const hasData = b.history && b.history.length;

  if(!hasData){
    return `<div class="bed"><b>Lova ${b.bed}</b></div>`;
  }

  const done = b.status === "DONE";

  return `
  <div class="bed">
    <b>Lova ${b.bed}</b><br>

    <div class="history">
      ${b.history.map(h=>{
        const t=new Date(h.time);
        return `• ${h.pain}/10 (${t.toLocaleTimeString("lt-LT")})`;
      }).join("<br>")}
    </div>

    ${!done ? `<button class="done" onclick="markDone('${b.token}')">Atlikta</button>` : ""}

    <button class="clear" onclick="clearBed('${b.token}')">
      Naujas pacientas
    </button>
  </div>`;
}

/* ===== LOAD ===== */

async function load(){
  try{
    const data = await api({
      action:"getDashboardDetailed",
      post:"1"
    });

    const grouped = groupByWard(data.beds || []);

    document.getElementById("grid").innerHTML =
      Object.entries(grouped)
        .sort((a,b)=>Number(a[0])-Number(b[0]))
        .map(([ward,beds])=>wardHTML(ward,beds))
        .join("");

    document.getElementById("time").innerText =
      "Atnaujinta " + new Date().toLocaleTimeString("lt-LT");

  }catch(e){
    console.error(e);
  }
}

/* ===== ACTIONS ===== */

async function markDone(token){
  await api({action:"markDone",id:token});
  load();
}

async function clearBed(token){
  if(!confirm("Ištrinti visus lovos duomenis?")) return;
  await api({action:"clearBedFull",id:token});
  load();
}

load();
setInterval(load,10000);
</script>

</body>
</html>

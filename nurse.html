<!doctype html>
<html lang="lt">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SlaugytojÅ³ langas â€“ Postas 1</title>

<style>
:root{
  --bg:#f3f4f6;
  --card:#fff;
  --text:#111827;
  --muted:#6b7280;
  --border:#111;
  --soft:#e5e7eb;
  --primary:#663399;
  --danger:#b00020;
  --dangerBg:#fff6f7;
  --ok:#166534;
  --okBg:#ecfdf5;
  --shadow:0 2px 10px rgba(0,0,0,.06);
  --shadowHover:0 8px 18px rgba(0,0,0,.10);
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* HEADER */
header{
  position:sticky;
  top:0;
  z-index:10;
  background:rgba(255,255,255,.92);
  backdrop-filter:blur(6px);
  border-bottom:1px solid var(--soft);
  padding:14px 18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.title{font-weight:900;font-size:16px}
.meta{font-size:12px;color:var(--muted)}

.actions{display:flex;gap:10px}

.btn{
  border:0;
  border-radius:14px;
  padding:.6rem 1rem;
  font-size:13px;
  cursor:pointer;
  background:var(--primary);
  color:#fff;
  font-weight:800;
}

.btn.secondary{
  background:#f9fafb;
  color:var(--text);
  border:1px solid var(--soft);
}

/* GRID */
.container{padding:18px}

.wards{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(360px,1fr));
  gap:18px;
  align-items:start;   /* ðŸ”¥ FIXAS â€“ palatos nebesitÄ™s */
}

/* WARD */
.ward{
  background:var(--card);
  border:1.5px solid var(--border);
  border-radius:18px;
  padding:14px;
  box-shadow:var(--shadow);
  align-self:start;
}

.wardHeaderRow{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}

.wardHeader{
  border:1.5px solid var(--border);
  padding:6px 12px;
  font-weight:900;
  border-radius:12px;
  font-size:15px;
}

.wardSub{
  font-size:12px;
  color:var(--muted);
  text-align:right;
}

/* Allergy ward */
.ward.allergy{
  border-color:var(--danger);
  background:var(--dangerBg);
  box-shadow:0 0 0 3px rgba(176,0,32,.08), var(--shadow);
}
.ward.allergy .wardHeader{
  border-color:var(--danger);
  color:var(--danger);
}

/* BEDS */
.beds{
  display:flex;
  flex-direction:column;
  gap:12px;
}

.bedCard{
  border:1.5px solid var(--border);
  border-radius:20px;
  padding:14px;
  background:#fff;
  transition:.15s ease;
}

.bedCard:hover{
  transform:translateY(-1px);
  box-shadow:var(--shadowHover);
}

.bedCard.done{
  background:linear-gradient(0deg, rgba(236,253,245,.7), rgba(236,253,245,.7)), #fff;
}

.bedTop{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
}

.bedTitle{
  font-weight:950;
  font-size:20px;
}

.newBtn{
  border:1.5px solid var(--border);
  background:#fff;
  border-radius:14px;
  padding:7px 10px;
  cursor:pointer;
  font-weight:900;
  font-size:12px;
}

.newBtn:hover{background:#f3f4f6}

.history{
  font-size:15px;
  line-height:1.5;
  white-space:pre-line;
}

.history.empty{
  font-size:13px;
  color:var(--muted);
}

.tags{
  display:flex;
  gap:7px;
  flex-wrap:wrap;
  margin-top:8px;
}

.tag{
  font-size:11px;
  padding:4px 9px;
  border-radius:999px;
  border:1px solid #d1d5db;
  background:#f9fafb;
  font-weight:900;
}

.tag.red{
  border-color:#f1b5c0;
  background:#ffeef1;
  color:#9f1239;
}

.tag.green{
  border-color:#bbf7d0;
  background:var(--okBg);
  color:var(--ok);
}
</style>
</head>

<body>
<header>
  <div>
    <div class="title">SlaugytojÅ³ langas â€“ Postas 1</div>
    <div class="meta" id="meta">â€“</div>
  </div>

  <div class="actions">
    <button class="btn secondary" id="soundBtn">Ä®jungti garsÄ…</button>
    <button class="btn" id="refreshBtn">Atnaujinti</button>
  </div>
</header>

<div class="container">
  <div class="wards" id="wards"></div>
</div>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbw4cdh6miY0FPdhHUaR8CxaRNarh01J1rY_QhCN7A5TTvyDgcDED57jZOBGk0g-m05b_A/exec";
const POST="1";
const REFRESH_SEC=10;

let audioEnabled=false;
let audioCtx=null;

function beep(){
  if(!audioEnabled) return;
  try{
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator();
    const g=audioCtx.createGain();
    o.frequency.value=880;
    g.gain.value=0.06;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>o.stop(),160);
  }catch(e){}
}

document.getElementById("soundBtn").addEventListener("click", async ()=>{
  try{
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    await audioCtx.resume();
    audioEnabled=true;
    const btn=document.getElementById("soundBtn");
    btn.textContent="Garsas Ä¯jungtas";
    btn.disabled=true;
    beep();
  }catch(e){
    alert("Nepavyko Ä¯jungti garso.");
  }
});

document.getElementById("refreshBtn").addEventListener("click", ()=>load(true));

async function api(params){
  const url = SCRIPT_URL + "?" + new URLSearchParams(params);
  const res = await fetch(url);
  return await res.json();
}

function fmtTime(iso){
  if(!iso) return "";
  const d=new Date(iso);
  if(isNaN(d.getTime())) return iso;
  return d.toLocaleTimeString("lt-LT",{hour:"2-digit",minute:"2-digit"});
}

function wardSortKey(w){
  const n=parseInt(w,10);
  return Number.isFinite(n)?n:999999;
}

/* ðŸ”¥ 12 lova gale */
function bedSortKey(b){
  const raw = b.bedNo ? String(b.bedNo) : String(b.bed||"").split("-")[1];
  const bn = parseInt(raw,10);

  if(bn===12) return 9999999;

  return Number.isFinite(bn)?bn:999999;
}

function groupByWard(items){
  const map=new Map();
  for(const b of items){
    const w=String(b.ward||"");
    if(!map.has(w)) map.set(w,[]);
    map.get(w).push(b);
  }
  return map;
}

function escapeJs(s){
  return String(s).replaceAll("\\","\\\\").replaceAll("'","\\'");
}

async function newPatient(token){
  if(!token) return;
  if(!confirm("PradÄ—ti naujÄ… pacientÄ…?")) return;
  await api({action:"clearBedFull", id:token});
  await load(true);
}
window.newPatient=newPatient;

function renderWard(ward,beds){
  const wardHasAllergy = beds.some(b=>String(b.allergy).toUpperCase()==="YES");
  const sortedBeds=[...beds].sort((a,b)=>bedSortKey(a)-bedSortKey(b));
  const doneCount=sortedBeds.filter(b=>String(b.status).toUpperCase()==="DONE").length;

  return `
    <section class="ward ${wardHasAllergy?"allergy":""}">
      <div class="wardHeaderRow">
        <div class="wardHeader">${ward} palata ${wardHasAllergy?"â€” ALERGIJA":""}</div>
        <div class="wardSub">
          LovÅ³: <b>${sortedBeds.length}</b><br>
          Atlikta: <b>${doneCount}</b>
        </div>
      </div>
      <div class="beds">
        ${sortedBeds.map(renderBedCard).join("")}
      </div>
    </section>
  `;
}

function renderBedCard(b){
  const bedNo=b.bedNo?String(b.bedNo):(String(b.bed||"").split("-")[1]||"");
  const hist=Array.isArray(b.history)?b.history:[];
  const hasHistory=hist.length>0;
  const allergyYes=String(b.allergy).toUpperCase()==="YES";
  const isDone=String(b.status).toUpperCase()==="DONE";

  const historyText = hasHistory
    ? hist.map(h=>`â€¢ ${h.pain}/10 (${fmtTime(h.time)})`).join("\\n")
    : "NÄ—ra vertinimÅ³.";

  return `
    <article class="bedCard ${isDone?"done":""}">
      <div class="bedTop">
        <div class="bedTitle">${bedNo} lova</div>
        <button class="newBtn" onclick="newPatient('${escapeJs(b.token||"")}')">Naujas pacientas</button>
      </div>
      <div class="history ${hasHistory?"":"empty"}">${historyText}</div>
      <div class="tags">
        ${allergyYes?`<span class="tag red">ALERGIJA</span>`:""}
        ${isDone?`<span class="tag green">ATLIKTA</span>`:""}
      </div>
    </article>
  `;
}

async function load(){
  const data=await api({action:"getPostBoard", post:POST});
  if(!data || data.ok!==true) return;

  const grouped=groupByWard(data.beds||[]);
  const wardsHtml=[...grouped.entries()]
    .sort((a,b)=>wardSortKey(a[0])-wardSortKey(b[0]))
    .map(([ward,list])=>renderWard(ward,list))
    .join("");

  document.getElementById("wards").innerHTML=wardsHtml;
  document.getElementById("meta").textContent =
    `Atnaujinama kas ${REFRESH_SEC}s â€¢ ` +
    new Date().toLocaleTimeString("lt-LT",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
}

load();
setInterval(load, REFRESH_SEC*1000);
</script>
</body>
</html>

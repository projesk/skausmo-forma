<!doctype html>
<html lang="lt">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Slaugytojų lentelė – Postas 1</title>
<style>
  body{font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:#f5f6f8;color:#111}
  header{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid #ddd;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .meta{font-size:12px;color:#666}
  .btn{border:0;border-radius:10px;padding:.55rem .9rem;font-size:13px;cursor:pointer;background:#663399;color:#fff}
  .btn.secondary{background:#f2f2f2;color:#111;border:1px solid #ddd}

  /* VISOS PALATOS (1 posto) tinkleliu */
  .wards{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(340px,1fr));
    gap:14px;
    padding:14px;
  }

  /* PALATOS korta */
  .ward{
    background:#fff;
    border:2px solid #111;
    border-radius:12px;
    padding:12px;
  }
  .wardHeader{
    display:inline-block;
    border:2px solid #111;
    padding:6px 10px;
    font-weight:900;
    border-radius:6px;
    margin-bottom:10px;
    background:#fff;
  }

  /* jei palatoje yra alergija – palata paryškinama */
  .ward.allergy{
    border-color:#b00020;
    box-shadow:0 0 0 3px rgba(176,0,32,.12);
    background:#fff5f6;
  }
  .wardHeader.allergy{
    border-color:#b00020;
    color:#b00020;
  }

  /* LOVOS kortelė palatos viduje */
  .bedCard{
    border:2px solid #111;
    border-radius:16px;
    padding:12px;
    margin:10px 0;
    background:#fff;
    min-height:120px;
  }

  .bedTop{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
    margin-bottom:8px;
  }

  .bedTitle{
    font-weight:900;
    font-size:20px;
    line-height:1.1;
  }

  .newBtn{
    border:2px solid #111;
    background:#fff;
    border-radius:10px;
    padding:6px 10px;
    cursor:pointer;
    font-weight:800;
  }
  .newBtn:hover{background:#f3f3f3}

  .history{
    font-size:16px;
    line-height:1.45;
    white-space:pre-line;
  }

  .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .tag{
    font-size:12px;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid #ccc;
    background:#fafafa;
    color:#333;
    font-weight:700;
  }
  .tag.red{border-color:#b00020;background:#ffe8ec;color:#8b0018}
  .tag.green{border-color:#22c55e;background:#eaf7ee;color:#14532d}
</style>
</head>

<body>
<header>
  <div>
    <div style="font-weight:900">Slaugytojų langas – Postas 1 (visos palatos ir lovos)</div>
    <div class="meta" id="meta">–</div>
  </div>
  <div style="display:flex;gap:10px;align-items:center">
    <button class="btn secondary" id="soundBtn">Įjungti garsą</button>
    <button class="btn" id="refreshBtn">Atnaujinti</button>
  </div>
</header>

<div class="wards" id="wards"></div>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbw4cdh6miY0FPdhHUaR8CxaRNarh01J1rY_QhCN7A5TTvyDgcDED57jZOBGk0g-m05b_A/exec";
const POST = "1";
const REFRESH_SEC = 10;

// garsas tik jei vartotoja įjungia
let audioEnabled=false;
let audioCtx=null;
function beep(){
  if(!audioEnabled) return;
  try{
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator();
    const g=audioCtx.createGain();
    o.frequency.value=880;
    g.gain.value=0.06;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>o.stop(),160);
  }catch(e){}
}
document.getElementById("soundBtn").addEventListener("click", async ()=>{
  try{
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    await audioCtx.resume();
    audioEnabled=true;
    document.getElementById("soundBtn").textContent="Garsas įjungtas";
    document.getElementById("soundBtn").disabled=true;
    beep();
  }catch(e){
    alert("Nepavyko įjungti garso (naršyklės ribojimai).");
  }
});

document.getElementById("refreshBtn").addEventListener("click", ()=>load(true));

async function api(params){
  const url = SCRIPT_URL + "?" + new URLSearchParams(params);
  const res = await fetch(url);
  return await res.json();
}

function fmtTime(iso){
  if(!iso) return "";
  const d=new Date(iso);
  if(isNaN(d.getTime())) return String(iso);
  return d.toLocaleTimeString("lt-LT",{hour:"2-digit",minute:"2-digit"});
}

function groupByWard(items){
  const map=new Map();
  for(const b of items){
    const w=String(b.ward||"");
    if(!map.has(w)) map.set(w, []);
    map.get(w).push(b);
  }
  return map;
}

// naujumo aptikimas garsui
const LS_KEY="post1_seen_lastTime";
let seen = {};
try{ seen = JSON.parse(localStorage.getItem(LS_KEY)||"{}"); }catch(e){ seen={}; }
let firstLoad=true;

function renderWard(ward, beds){
  const wardHasAllergy = beds.some(b => String(b.allergy).toUpperCase()==="YES");

  return `
    <div class="ward ${wardHasAllergy ? "allergy" : ""}">
      <div class="wardHeader ${wardHasAllergy ? "allergy" : ""}">
        ${ward} palata ${wardHasAllergy ? "— ALERGIJA" : ""}
      </div>

      ${beds.map(renderBedCard).join("")}
    </div>
  `;
}

function renderBedCard(b){
  const bedNo = b.bedNo ? String(b.bedNo) : (String(b.bed).split("-")[1] || "");
  const title = `${bedNo} lova`;

  const hist = Array.isArray(b.history) ? b.history : [];
  const hasHistory = hist.length > 0;

  // jei nėra vertinimų – nieko nerodom (tik pavadinimą + mygtuką)
  const historyText = hasHistory
    ? hist.map(h => `• ${h.pain}/10 (${fmtTime(h.time)})`).join("\n")
    : "";

  const allergyYes = String(b.allergy).toUpperCase()==="YES";
  const isDone = String(b.status).toUpperCase()==="DONE";

  return `
    <div class="bedCard">
      <div class="bedTop">
        <div class="bedTitle">${title}</div>
        <button class="newBtn" onclick="newPatient('${escapeJs(b.token||"")}')">Naujas pacientas</button>
      </div>

      <div class="history">${historyText}</div>

      <div class="tags">
        ${allergyYes ? `<span class="tag red">ALERGIJA</span>` : ``}
        ${isDone ? `<span class="tag green">ATLIKTA</span>` : ``}
      </div>
    </div>
  `;
}

function escapeJs(s){
  return String(s).replaceAll("\\","\\\\").replaceAll("'","\\'");
}

async function newPatient(token){
  if(!token) return;
  if(!confirm("Ar tikrai pradėti naują pacientą? Bus ištrinti visi šios lovos vertinimai.")) return;
  await api({ action:"clearBedFull", id: token });
  await load(true);
}

async function load(manual=false){
  const data = await api({ action:"getPostBoard", post: POST });

  if(!data || data.ok !== true){
    alert("Klaida gaunant duomenis.");
    return;
  }

  const beds = data.beds || [];

  // garsas, jei pasikeitė lastTime
  let newEntry=false;
  const nextSeen={...seen};
  for(const b of beds){
    const t = String(b.token||"");
    const lt = String(b.lastTime||"");
    if(!t || !lt) continue;
    const prev = String(seen[t]||"");
    if(!firstLoad && prev && lt !== prev) newEntry=true;
    nextSeen[t]=lt;
  }
  firstLoad=false;
  seen=nextSeen;
  try{ localStorage.setItem(LS_KEY, JSON.stringify(seen)); }catch(e){}
  if(newEntry) beep();

  const grouped = groupByWard(beds);

  // render
  const wardsHtml = [...grouped.entries()]
    .sort((a,b)=>parseInt(a[0],10)-parseInt(b[0],10))
    .map(([ward, list]) => renderWard(ward, list))
    .join("");

  document.getElementById("wards").innerHTML = wardsHtml || `<div style="padding:14px;color:#666">Nėra QR lovų poste 1.</div>`;

  document.getElementById("meta").textContent =
    `Atnaujinama kas ${REFRESH_SEC}s • Paskutinis atnaujinimas: ` +
    new Date().toLocaleTimeString("lt-LT",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
}

load(true);
setInterval(load, REFRESH_SEC*1000);
</script>
</body>
</html>

<!doctype html>
<html lang="lt">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Slaugytojų langas – Postas 1</title>

<style>
:root{
  --bg:#f3f4f6;
  --card:#fff;
  --text:#111827;
  --muted:#6b7280;
  --border:#111;
  --soft:#e5e7eb;
  --primary:#663399;
  --danger:#b00020;
  --dangerBg:#fff6f7;
  --ok:#166534;
  --okBg:#ecfdf5;
  --shadow:0 2px 10px rgba(0,0,0,.06);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* HEADER */
header{
  position:sticky; top:0; z-index:10;
  background:rgba(255,255,255,.95);
  backdrop-filter:blur(6px);
  border-bottom:1px solid var(--soft);
  padding:14px 18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.title{font-weight:900;font-size:16px}
.meta{font-size:12px;color:var(--muted)}
.actions{display:flex;gap:10px}

.btn{
  border:0;border-radius:14px;
  padding:.6rem 1rem;
  font-size:13px;
  cursor:pointer;
  background:var(--primary);
  color:#fff;
  font-weight:800;
}
.btn.secondary{
  background:#f9fafb;
  color:var(--text);
  border:1px solid var(--soft);
}

/* LAYOUT */
.container{padding:18px}

/* ✅ TIKSLI 2 stulpelių schema */
.wards{
  display:grid;
  grid-template-columns:minmax(320px, 1fr) minmax(320px, 1fr);
  gap:18px;
  align-items:start;
}

/* Mobile: vienas stulpelis (schema išsities į apačią) */
@media (max-width: 900px){
  .wards{grid-template-columns:1fr}
  .spacer{display:none;}
}

/* Spacer (tuščias langelis) */
.spacer{
  min-height:1px;
}

/* WARD CARD */
.ward{
  background:var(--card);
  border:1.5px solid var(--border);
  border-radius:18px;
  padding:14px;
  box-shadow:var(--shadow);
}

.wardHeaderRow{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}

.wardHeader{
  border:1.5px solid var(--border);
  padding:6px 12px;
  font-weight:900;
  border-radius:12px;
  font-size:15px;
}

.wardSub{
  font-size:12px;
  color:var(--muted);
  text-align:right;
}

/* Allergy ward */
.ward.allergy{
  border-color:var(--danger);
  background:var(--dangerBg);
  box-shadow:0 0 0 3px rgba(176,0,32,.08);
}
.ward.allergy .wardHeader{
  border-color:var(--danger);
  color:var(--danger);
}

/* BEDS */
.beds{display:flex;flex-direction:column;gap:10px}

.bedCard{
  border:1.5px solid var(--border);
  border-radius:16px;
  padding:10px 12px;
  background:#fff;
}

.bedCard.done{
  background:linear-gradient(0deg, rgba(236,253,245,.7), rgba(236,253,245,.7)), #fff;
}

.bedTop{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.bedTitle{font-weight:900;font-size:17px}

.newBtn{
  border:1.5px solid var(--border);
  background:#fff;
  border-radius:12px;
  padding:5px 8px;
  cursor:pointer;
  font-weight:800;
  font-size:11px;
}
.newBtn:hover{background:#f3f4f6}

.history{
  font-size:13px;
  color:var(--muted);
  margin-top:2px;
  line-height:1.35;
}

.tags{
  display:flex;
  gap:6px;
  margin-top:6px;
  flex-wrap:wrap;
}

.tag{
  font-size:10px;
  padding:3px 7px;
  border-radius:999px;
  border:1px solid #d1d5db;
  background:#f9fafb;
  font-weight:900;
}
.tag.red{border-color:#f1b5c0;background:#ffeef1;color:#9f1239}
.tag.green{border-color:#bbf7d0;background:var(--okBg);color:var(--ok)}
</style>
</head>

<body>
<header>
  <div>
    <div class="title">Slaugytojų langas – Postas 1</div>
    <div class="meta" id="meta">–</div>
  </div>

  <div class="actions">
    <button class="btn secondary" id="soundBtn">Įjungti garsą</button>
    <button class="btn" id="refreshBtn">Atnaujinti</button>
  </div>
</header>

<div class="container">
  <div class="wards" id="wards"></div>
</div>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbw4cdh6miY0FPdhHUaR8CxaRNarh01J1rY_QhCN7A5TTvyDgcDED57jZOBGk0g-m05b_A/exec";
const POST="1";
const REFRESH_SEC=10;

/* ✅ TAVO SCHEMA (2 stulpeliai, su tuščiom vietom)
   34 | 38
   -- | 40
   36 | 44
   37 | 45
   -- | 12
*/
const SCHEMA_SLOTS = [
  "34","38",
  null,"40",
  "36","44",
  "37","45",
  null,"12",
];

let audioEnabled=false;
let audioCtx=null;

function beep(){
  if(!audioEnabled) return;
  try{
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator();
    const g=audioCtx.createGain();
    o.frequency.value=880;
    g.gain.value=0.06;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>o.stop(),160);
  }catch(e){}
}

document.getElementById("soundBtn").addEventListener("click", async ()=>{
  try{
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    await audioCtx.resume();
    audioEnabled=true;
    const btn=document.getElementById("soundBtn");
    btn.textContent="Garsas įjungtas";
    btn.disabled=true;
    beep();
  }catch(e){
    alert("Nepavyko įjungti garso.");
  }
});

document.getElementById("refreshBtn").addEventListener("click", ()=>load(true));

async function api(params){
  const url = SCRIPT_URL + "?" + new URLSearchParams(params);
  const res = await fetch(url);
  return await res.json();
}

function fmtTime(iso){
  if(!iso) return "";
  const d=new Date(iso);
  if(isNaN(d.getTime())) return String(iso);
  return d.toLocaleTimeString("lt-LT",{hour:"2-digit",minute:"2-digit"});
}

function groupByWard(items){
  const map=new Map();
  for(const b of items){
    const w=String(b.ward||"");
    if(!map.has(w)) map.set(w, []);
    map.get(w).push(b);
  }
  return map;
}

/* ✅ 12 lova visada gale */
function bedSortKey(b){
  const raw = b.bedNo ? String(b.bedNo) : String(b.bed||"").split("-")[1];
  const bn = parseInt(raw,10);
  if (bn === 12) return 9999999;
  return Number.isFinite(bn) ? bn : 999999;
}

function escapeJs(s){
  return String(s).replaceAll("\\","\\\\").replaceAll("'","\\'");
}

async function newPatient(token){
  if(!token) return;
  if(!confirm("Pradėti naują pacientą?")) return;
  await api({action:"clearBedFull", id:token});
  await load(true);
}
window.newPatient=newPatient;

function renderWard(ward,beds){
  const wardHasAllergy = beds.some(b => String(b.allergy).toUpperCase()==="YES");
  const sortedBeds = [...beds].sort((a,b)=>bedSortKey(a)-bedSortKey(b));
  const doneCount = sortedBeds.filter(b=>String(b.status).toUpperCase()==="DONE").length;

  return `
    <section class="ward ${wardHasAllergy ? "allergy" : ""}">
      <div class="wardHeaderRow">
        <div class="wardHeader">${ward} palata ${wardHasAllergy ? "— ALERGIJA" : ""}</div>
        <div class="wardSub">
          Lovų: <b>${sortedBeds.length}</b><br>
          Atlikta: <b>${doneCount}</b>
        </div>
      </div>
      <div class="beds">
        ${sortedBeds.map(renderBedCard).join("")}
      </div>
    </section>
  `;
}

function renderBedCard(b){
  const bedNo = b.bedNo ? String(b.bedNo) : (String(b.bed||"").split("-")[1] || "");
  const hist = Array.isArray(b.history) ? b.history : [];
  const allergyYes = String(b.allergy).toUpperCase()==="YES";
  const isDone = String(b.status).toUpperCase()==="DONE";

  const historyText = hist.length
    ? hist.map(h => `• ${h.pain}/10 (${fmtTime(h.time)})`).join("<br>")
    : "Nėra vertinimų.";

  return `
    <article class="bedCard ${isDone ? "done" : ""}">
      <div class="bedTop">
        <div class="bedTitle">${bedNo} lova</div>
        <button class="newBtn" onclick="newPatient('${escapeJs(b.token||"")}')">Naujas pacientas</button>
      </div>
      <div class="history">${historyText}</div>
      <div class="tags">
        ${allergyYes ? `<span class="tag red">ALERGIJA</span>` : ``}
        ${isDone ? `<span class="tag green">ATLIKTA</span>` : ``}
      </div>
    </article>
  `;
}

/* garsas pagal lastTime kaip anksčiau */
const LS_KEY="post1_seen_lastTime";
let seen = {};
try{ seen = JSON.parse(localStorage.getItem(LS_KEY)||"{}"); }catch(e){ seen={}; }
let firstLoad=true;

async function load(){
  const data = await api({action:"getPostBoard", post:POST});
  if(!data || data.ok !== true) return;

  const beds = data.beds || [];

  // beep jei pasikeitė lastTime
  let newEntry=false;
  const nextSeen={...seen};
  for(const b of beds){
    const t = String(b.token||"");
    const lt = String(b.lastTime||"");
    if(!t || !lt) continue;
    const prev = String(seen[t]||"");
    if(!firstLoad && prev && lt !== prev) newEntry=true;
    nextSeen[t]=lt;
  }
  firstLoad=false;
  seen=nextSeen;
  try{ localStorage.setItem(LS_KEY, JSON.stringify(seen)); }catch(e){}
  if(newEntry) beep();

  const grouped = groupByWard(beds);

  // ✅ Renderinam pagal tavo SCHEMA_SLOTS (su tuščiais langeliais)
  const html = SCHEMA_SLOTS.map(slot => {
    if(slot === null) return `<div class="spacer"></div>`;
    const list = grouped.get(String(slot)) || [];
    // jei palata dar neturi lovų duomenų – rodome tuščią kortą (kad schema nesugriūtų)
    return renderWard(String(slot), list);
  }).join("");

  document.getElementById("wards").innerHTML = html;

  document.getElementById("meta").textContent =
    `Atnaujinama kas ${REFRESH_SEC}s • ` +
    new Date().toLocaleTimeString("lt-LT",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
}

load();
setInterval(load, REFRESH_SEC*1000);
</script>
</body>
</html>

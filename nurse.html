<!doctype html>
<html lang="lt">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Slaugytojų langas – Postas 1</title>

<style>
:root{
  --bg:#f3f4f6;
  --card:#fff;
  --text:#111827;
  --muted:#6b7280;
  --border:#111;
  --soft:#e5e7eb;
  --primary:#663399;
  --danger:#b00020;
  --dangerBg:#fff6f7;
  --ok:#166534;
  --okBg:#ecfdf5;
  --shadow:0 2px 10px rgba(0,0,0,.06);
  --shadowHover:0 8px 18px rgba(0,0,0,.10);
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* HEADER */
header{
  position:sticky;
  top:0;
  z-index:10;
  background:rgba(255,255,255,.95);
  backdrop-filter:blur(6px);
  border-bottom:1px solid var(--soft);
  padding:14px 18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
}

.title{font-weight:900;font-size:16px}
.meta{font-size:12px;color:var(--muted)}
.actions{display:flex;gap:10px;align-items:center}

.btn{
  border:0;
  border-radius:14px;
  padding:.6rem 1rem;
  font-size:13px;
  cursor:pointer;
  background:var(--primary);
  color:#fff;
  font-weight:800;
  user-select:none;
}
.btn.secondary{
  background:#f9fafb;
  color:var(--text);
  border:1px solid var(--soft);
}

/* LAYOUT */
.container{padding:18px}

/* ✅ MASONRY: 2 realūs stulpeliai, be skylių */
.wards{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:18px;
  align-items:start;
}

.col{
  display:flex;
  flex-direction:column;
  gap:18px;
  align-items:stretch;
}

/* Mobile: viena kolona */
@media (max-width: 980px){
  .wards{grid-template-columns:1fr}
}

/* WARD */
.ward{
  background:var(--card);
  border:1.5px solid var(--border);
  border-radius:18px;
  padding:14px;
  box-shadow:var(--shadow);
}

.wardHeaderRow{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
  gap:10px;
}

.wardHeader{
  border:1.5px solid var(--border);
  padding:6px 12px;
  font-weight:900;
  border-radius:12px;
  font-size:15px;
  white-space:nowrap;
}

.wardSub{
  font-size:12px;
  color:var(--muted);
  text-align:right;
  white-space:nowrap;
}

/* Allergy ward */
.ward.allergy{
  border-color:var(--danger);
  background:var(--dangerBg);
  box-shadow:0 0 0 3px rgba(176,0,32,.08), var(--shadow);
}
.ward.allergy .wardHeader{
  border-color:var(--danger);
  color:var(--danger);
}

/* BEDS */
.beds{
  display:flex;
  flex-direction:column;
  gap:10px;
}

.bedCard{
  border:1.5px solid var(--border);
  border-radius:16px;
  padding:10px 12px;
  background:#fff;
  transition:.12s ease;
}
.bedCard:hover{
  transform:translateY(-1px);
  box-shadow:var(--shadowHover);
}

.bedCard.done{
  background:linear-gradient(0deg, rgba(236,253,245,.7), rgba(236,253,245,.7)), #fff;
}

.bedTop{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}

.bedTitle{
  font-weight:900;
  font-size:17px;
}

.newBtn{
  border:1.5px solid var(--border);
  background:#fff;
  border-radius:12px;
  padding:5px 8px;
  cursor:pointer;
  font-weight:800;
  font-size:11px;
  user-select:none;
}
.newBtn:hover{background:#f3f4f6}

.history{
  font-size:13px;
  color:var(--muted);
  margin-top:2px;
  line-height:1.35;
}

.tags{
  display:flex;
  gap:6px;
  margin-top:6px;
  flex-wrap:wrap;
}

.tag{
  font-size:10px;
  padding:3px 7px;
  border-radius:999px;
  border:1px solid #d1d5db;
  background:#f9fafb;
  font-weight:900;
}
.tag.red{border-color:#f1b5c0;background:#ffeef1;color:#9f1239}
.tag.green{border-color:#bbf7d0;background:var(--okBg);color:var(--ok)}
</style>
</head>

<body>
<header>
  <div>
    <div class="title">Slaugytojų langas – Postas 1</div>
    <div class="meta" id="meta">–</div>
  </div>

  <div class="actions">
    <button class="btn secondary" id="soundBtn">Įjungti garsą</button>
    <button class="btn" id="refreshBtn">Atnaujinti</button>
  </div>
</header>

<div class="container">
  <div class="wards">
    <div class="col" id="colL"></div>
    <div class="col" id="colR"></div>
  </div>
</div>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbw4cdh6miY0FPdhHUaR8CxaRNarh01J1rY_QhCN7A5TTvyDgcDED57jZOBGk0g-m05b_A/exec";
const POST="1";
const REFRESH_SEC=10;

/* ✅ Tavo norima palatų seka (kaip parašei) */
const WARD_ORDER = ["34","38","40","36","44","37","45","12"];

// garsas tik jei vartotoja įjungia
let audioEnabled=false;
let audioCtx=null;
function beep(){
  if(!audioEnabled) return;
  try{
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator();
    const g=audioCtx.createGain();
    o.frequency.value=880;
    g.gain.value=0.06;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>o.stop(),160);
  }catch(e){}
}

document.getElementById("soundBtn").addEventListener("click", async ()=>{
  try{
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    await audioCtx.resume();
    audioEnabled=true;
    const btn=document.getElementById("soundBtn");
    btn.textContent="Garsas įjungtas";
    btn.disabled=true;
    beep();
  }catch(e){
    alert("Nepavyko įjungti garso.");
  }
});

document.getElementById("refreshBtn").addEventListener("click", ()=>load(true));

async function api(params){
  const url = SCRIPT_URL + "?" + new URLSearchParams(params);
  const res = await fetch(url);
  return await res.json();
}

function fmtTime(iso){
  if(!iso) return "";
  const d=new Date(iso);
  if(isNaN(d.getTime())) return String(iso);
  return d.toLocaleTimeString("lt-LT",{hour:"2-digit",minute:"2-digit"});
}

function groupByWard(items){
  const map=new Map();
  for(const b of items){
    const w=String(b.ward||"");
    if(!map.has(w)) map.set(w, []);
    map.get(w).push(b);
  }
  return map;
}

/* ✅ 12 lova palatos viduje visada gale */
function bedSortKey(b){
  const raw = b.bedNo ? String(b.bedNo) : String(b.bed||"").split("-")[1];
  const bn = parseInt(raw,10);
  if (bn === 12) return 9999999;
  return Number.isFinite(bn) ? bn : 999999;
}

function escapeJs(s){
  return String(s).replaceAll("\\","\\\\").replaceAll("'","\\'");
}

async function newPatient(token){
  if(!token) return;
  if(!confirm("Pradėti naują pacientą?")) return;
  await api({action:"clearBedFull", id:token});
  await load(true);
}
window.newPatient=newPatient;

function renderWardHtml(ward, beds){
  const wardHasAllergy = beds.some(b => String(b.allergy).toUpperCase()==="YES");
  const sortedBeds = [...beds].sort((a,b)=>bedSortKey(a)-bedSortKey(b));
  const doneCount = sortedBeds.filter(b => String(b.status).toUpperCase()==="DONE").length;

  return `
    <section class="ward ${wardHasAllergy ? "allergy" : ""}">
      <div class="wardHeaderRow">
        <div class="wardHeader">${ward} palata ${wardHasAllergy ? "— ALERGIJA" : ""}</div>
        <div class="wardSub">
          Lovų: <b>${sortedBeds.length}</b><br>
          Atlikta: <b>${doneCount}</b>
        </div>
      </div>

      <div class="beds">
        ${sortedBeds.map(renderBedCardHtml).join("")}
      </div>
    </section>
  `;
}

function renderBedCardHtml(b){
  const bedNo = b.bedNo ? String(b.bedNo) : (String(b.bed||"").split("-")[1] || "");
  const hist = Array.isArray(b.history) ? b.history : [];
  const allergyYes = String(b.allergy).toUpperCase()==="YES";
  const isDone = String(b.status).toUpperCase()==="DONE";

  const historyText = hist.length
    ? hist.map(h => `• ${h.pain}/10 (${fmtTime(h.time)})`).join("<br>")
    : "Nėra vertinimų.";

  return `
    <article class="bedCard ${isDone ? "done" : ""}">
      <div class="bedTop">
        <div class="bedTitle">${bedNo} lova</div>
        <button class="newBtn" onclick="newPatient('${escapeJs(b.token||"")}')">Naujas pacientas</button>
      </div>
      <div class="history">${historyText}</div>
      <div class="tags">
        ${allergyYes ? `<span class="tag red">ALERGIJA</span>` : ``}
        ${isDone ? `<span class="tag green">ATLIKTA</span>` : ``}
      </div>
    </article>
  `;
}

/* garsas pagal lastTime */
const LS_KEY="post1_seen_lastTime";
let seen = {};
try{ seen = JSON.parse(localStorage.getItem(LS_KEY)||"{}"); }catch(e){ seen={}; }
let firstLoad=true;

function numericWardSort(a,b){
  const na=parseInt(a,10), nb=parseInt(b,10);
  if(Number.isFinite(na) && Number.isFinite(nb)) return na-nb;
  return String(a).localeCompare(String(b));
}

function makeElFromHtml(html){
  const wrap=document.createElement("div");
  wrap.innerHTML=html.trim();
  return wrap.firstElementChild;
}

/* ✅ Masonry packing: dedam į trumpesnį stulpelį */
function masonryPlace(wardEls){
  const colL=document.getElementById("colL");
  const colR=document.getElementById("colR");
  colL.innerHTML=""; colR.innerHTML="";

  // jei mobile (1 kolona) – viską į kairę
  const oneColumn = window.matchMedia("(max-width: 980px)").matches;

  let hL=0, hR=0;
  for(const el of wardEls){
    if(oneColumn){
      colL.appendChild(el);
      continue;
    }
    if(hL <= hR){
      colL.appendChild(el);
      hL += el.getBoundingClientRect().height + 18;
    }else{
      colR.appendChild(el);
      hR += el.getBoundingClientRect().height + 18;
    }
  }
}

async function load(){
  const data = await api({action:"getPostBoard", post:POST});
  if(!data || data.ok !== true) return;

  const beds = data.beds || [];

  // beep jei pasikeitė lastTime
  let newEntry=false;
  const nextSeen={...seen};
  for(const b of beds){
    const t = String(b.token||"");
    const lt = String(b.lastTime||"");
    if(!t || !lt) continue;
    const prev = String(seen[t]||"");
    if(!firstLoad && prev && lt !== prev) newEntry=true;
    nextSeen[t]=lt;
  }
  firstLoad=false;
  seen=nextSeen;
  try{ localStorage.setItem(LS_KEY, JSON.stringify(seen)); }catch(e){}
  if(newEntry) beep();

  const grouped = groupByWard(beds);

  // palatos pagal tavo norimą order, o kitos – gale
  const allWards = [...grouped.keys()];
  const ordered = [];
  const used = new Set();

  for(const w of WARD_ORDER){
    if(grouped.has(String(w))){
      ordered.push(String(w));
      used.add(String(w));
    }else{
      // jei palata dar neturi lovų – vis tiek rodom (tuščią), kad schema laikytųsi
      ordered.push(String(w));
      used.add(String(w));
    }
  }

  const rest = allWards.filter(w => !used.has(String(w))).sort(numericWardSort);
  const finalWardList = [...ordered, ...rest];

  const wardEls = finalWardList.map(ward=>{
    const list = grouped.get(String(ward)) || [];
    return makeElFromHtml(renderWardHtml(String(ward), list));
  });

  // po to kai elementai DOM’e, jų aukščius galim matuoti
  masonryPlace(wardEls);

  document.getElementById("meta").textContent =
    `Atnaujinama kas ${REFRESH_SEC}s • ` +
    new Date().toLocaleTimeString("lt-LT",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
}

load();
setInterval(load, REFRESH_SEC*1000);

// perskaičiavimas keičiant lango plotį (kad masonry nesusigadintų)
window.addEventListener("resize", ()=>{
  // lengvas debounce
  clearTimeout(window.__masonryT);
  window.__masonryT=setTimeout(load, 120);
});
</script>
</body>
</html>
